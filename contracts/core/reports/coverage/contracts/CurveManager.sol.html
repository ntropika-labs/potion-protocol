<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/CurveManager.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> CurveManager.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>24/24</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>28/28</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>7/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>27/27</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116×</span>
<span class="cline-any cline-yes">116×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-yes">109×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">223×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">143×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">293×</span>
<span class="cline-any cline-yes">290×</span>
<span class="cline-any cline-yes">288×</span>
<span class="cline-any cline-yes">288×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">280×</span>
<span class="cline-any cline-yes">279×</span>
<span class="cline-any cline-yes">278×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">278×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">278×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">127×</span>
<span class="cline-any cline-yes">125×</span>
<span class="cline-any cline-yes">123×</span>
<span class="cline-any cline-yes">121×</span>
<span class="cline-any cline-yes">119×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">116×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * SPDX-License-Identifier: Apache-2.0
 */
pragma solidity 0.8.4;
import { OtokenInterface } from "./packages/opynInterface/OtokenInterface.sol";
import { PRBMathSD59x18 } from "./packages/PRBMathSD59x18.sol";
import { ICurveManager } from "./interfaces/ICurveManager.sol";
&nbsp;
/**
 * @title CurveManagerNew
 * @notice Keeps a registry of all Curves that are known to the Potion protocol
 */
contract CurveManager is ICurveManager {
    using PRBMathSD59x18 for int256;
&nbsp;
    ///////////////////////////////////////////////////////////////////////////
    //  Curve constraints
    ///////////////////////////////////////////////////////////////////////////
    /// @dev PRBMathSD59x18 scale numbers to 1e18, so it can represents numbers in that range.
    int256 private constant A_LOWER_BOUND = 0;
    int256 private constant A_UPPER_BOUND = 10e18; // 10 as 59x18 decimal
    int256 private constant B_LOWER_BOUND = 0;
    int256 private constant B_UPPER_BOUND = 20e18; // 20 as 59x18 decimal
    int256 private constant C_LOWER_BOUND = 0;
    int256 private constant C_UPPER_BOUND = 1000e18; // 1000 as 59x18 decimal
    int256 private constant D_LOWER_BOUND = 0;
    int256 private constant D_UPPER_BOUND = 20e18; // 20 as 59x18 decimal
    int256 private constant UTIL_LOWER_BOUND = 0; // 0 -&gt; 0%. Also used as bound for max_util
    int256 private constant UTIL_UPPER_BOUND = 1e18; // 1 -&gt; 100%  as 59x18 decimal. Also used as bound for max_util
&nbsp;
    /// @dev whether a Curve instance is known to us, indexed by the hash of the struct
    mapping(bytes32 =&gt; bool) public registeredCurves;
&nbsp;
    ///////////////////////////////////////////////////////////////////////////
    //  Public interfaces
    ///////////////////////////////////////////////////////////////////////////
&nbsp;
    /**
     * @notice Add the specified Curve to the registry of Curves that are known to our contract
     * @param _curve The Curve to register
     * @return hash The keccak256 of the Curve
     */
    function addCurve(Curve calldata _curve) external override onlyValidCurves(_curve) returns (bytes32 hash) {
        hash = hashCurve(_curve);
        if (!registeredCurves[hash]) {
            registeredCurves[hash] = true;
            emit CurveAdded(hash, _curve);
        }
        return hash;
    }
&nbsp;
    /**
     * @notice Get the hash of given Curve
     * @param _curve The Curve to be hashed.
     * @return The keccak256 hash of the Curve
     */
    function hashCurve(Curve calldata _curve) public pure override returns (bytes32) {
        return
            keccak256(
                abi.encodePacked(_curve.a_59x18, _curve.b_59x18, _curve.c_59x18, _curve.d_59x18, _curve.max_util_59x18)
            );
    }
&nbsp;
    /**
     * @notice Check whether the specified hash is the hash of a Curve that is known to our contract
     * @param _hash The hash to look for
     * @return valid True if the hash is that of a known Curve; false if it is not
     */
    function isKnownCurveHash(bytes32 _hash) external view override returns (bool valid) {
        return registeredCurves[_hash];
    }
&nbsp;
    /**
     * @notice Calculate x^y, assuming 0^0 is 1, where x and y are both signed 59x18 fixed point numbers
     * @dev Revert on overflow.
     *
     * @param _x_59x18 Signed 59x18-bit fixed point number
     * @param _y_59x18 Signed 59x18-bit fixed point number
     * @return Signed 59x18-bit fixed point number
     */
    function powerDecimal(int256 _x_59x18, int256 _y_59x18) external pure returns (int256) {
        require(_x_59x18 &gt;= 0, "powerDecimal: base must be &gt;= 0");
&nbsp;
        if (_x_59x18 == 0 &amp;&amp; _y_59x18 == 0) {
            // Return 1 as a 59x18-bit fixed point number
            return 1e18;
        } else if (_x_59x18 == 0) {
            return 0; // ln(0) undefined so require special case
        } else {
            return _y_59x18.mul(_x_59x18.ln()).exp();
        }
    }
&nbsp;
    /**
     * @notice Calculates hyperbolic cosine of an input x, using the formula:
     *
     *            e^x + e^(-x)
     * cosh(x) =  ------------
     *                 2
     *
     * @dev The input and output are signed 59x18-bit fixed point number.
     * @param _input59x18 Signed 59x18-bit fixed point number, less than or equal to 10.
     * @return output59x18 Result of computing the hyperbolic cosine of an input x
     */
    function cosh(int256 _input59x18) public pure override returns (int256 output59x18) {
        // The maximum input we need to support when called by hyperbolicCurve is `b*x^c`
        // We know that |x| &lt;= 1, so the max input we must support is B_UPPER_BOUND
        require(_input59x18 &gt;= 0, "Cosh input &lt; 0");
        require(_input59x18 &lt;= B_UPPER_BOUND, "Cosh input too high");
        int256 numerator = _input59x18.exp().add(_input59x18.mul(PRBMathSD59x18.fromInt(-1)).exp());
        return numerator.div(PRBMathSD59x18.fromInt(2));
    }
&nbsp;
    /**
     * @notice Evaluates the function defined by curve c at point x (0 &lt;= x &lt;= 1), example:
     *
     *    a * x * cosh(b*x^c) + d
     *
     * @dev x is typically utilisation as a fraction (1 = 100%). We only support 0 &lt;= x &lt;= 1.
     * @dev All inputs are signed 59x18-bit fixed point numbers
     * @dev The output is a signed 59x18-bit fixed point number.
     * @param _curve The Curve values to be used by the function expression mentioned above.
     * @param _x_59x18 The point at which the function expression mentioned above will be calculated. Must be between 0 and 1, inclusive.
     * @return output59x18 Result of the function expression mentioned above evaluated at point x.
     */
    function hyperbolicCurve(Curve calldata _curve, int256 _x_59x18)
        external
        pure
        override
        returns (int256 output59x18)
    {
        // We do not check that the curve is valid here, but note that only valid curves can be added to our registry
        require(_x_59x18 &gt;= UTIL_LOWER_BOUND, "x input too low");
        require(_x_59x18 &lt;= UTIL_UPPER_BOUND, "x input too high");
        int256 coshPart = cosh(_curve.b_59x18.mul(PRBMathSD59x18.pow(_x_59x18, _curve.c_59x18)));
&nbsp;
        output59x18 = _curve.d_59x18.add(coshPart.mul(_curve.a_59x18).mul(_x_59x18));
&nbsp;
        return output59x18;
    }
&nbsp;
    ///////////////////////////////////////////////////////////////////////////
    //  Internals
    ///////////////////////////////////////////////////////////////////////////
    modifier onlyValidCurves(Curve calldata _curve) {
        require(_curve.a_59x18 &gt;= A_LOWER_BOUND &amp;&amp; _curve.a_59x18 &lt;= A_UPPER_BOUND, "Invalid A value");
        require(_curve.b_59x18 &gt;= B_LOWER_BOUND &amp;&amp; _curve.b_59x18 &lt;= B_UPPER_BOUND, "Invalid B value");
        require(_curve.c_59x18 &gt;= C_LOWER_BOUND &amp;&amp; _curve.c_59x18 &lt;= C_UPPER_BOUND, "Invalid C value");
        require(_curve.d_59x18 &gt;= D_LOWER_BOUND &amp;&amp; _curve.d_59x18 &lt;= D_UPPER_BOUND, "Invalid D value");
        require(
            _curve.max_util_59x18 &gt; UTIL_LOWER_BOUND &amp;&amp; _curve.max_util_59x18 &lt;= UTIL_UPPER_BOUND,
            "Invalid Max util value"
        );
        _;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Sep 13 2022 17:37:16 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
