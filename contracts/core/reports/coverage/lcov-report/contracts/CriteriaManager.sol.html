<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/CriteriaManager.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> CriteriaManager.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>33/33</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">78.13% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>25/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/8</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>34/34</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">139×</span>
<span class="cline-any cline-yes">139×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">209×</span>
<span class="cline-any cline-yes">209×</span>
<span class="cline-any cline-yes">209×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">132×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">139×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">277×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">145×</span>
<span class="cline-any cline-yes">145×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">220×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">141×</span>
<span class="cline-any cline-yes">83×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">85×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">140×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">72×</span>
<span class="cline-any cline-yes">72×</span>
<span class="cline-any cline-yes">72×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-yes">155×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * SPDX-License-Identifier: Apache-2.0
 */
pragma solidity 0.8.4;
import { OtokenInterface } from "./packages/opynInterface/OtokenInterface.sol";
import { ICriteriaManager } from "./interfaces/ICriteriaManager.sol";
&nbsp;
/**
 * @title CriteriaManager
 * @notice Keeps a registry of all Criteria and CriteriaSet instances that are know to the Potion protocol.
 */
contract CriteriaManager is ICriteriaManager {
    /// @dev the (non-enumerable) Criteria instances that are known to us, indexed by the hash of the struct
    mapping(bytes32 =&gt; bool) public registeredCriteria;
    /// @dev the (non-enumerable) CriteriaSet instances that are known to us, indexed by the hash of the *ordered* list of Criteria hashes in the CriteriaSet
    mapping(bytes32 =&gt; CriteriaSet) public criteriaSetByHash;
&nbsp;
    ///////////////////////////////////////////////////////////////////////////
    //  Public interfaces
    ///////////////////////////////////////////////////////////////////////////
&nbsp;
    /**
     * @notice Add the specified set of Criteria to the registry of CriteriaSets that are known to our contract.
     * @param _hashes A sorted list of bytes32 values, each being the hash of a known Criteria. No duplicates, so this can be considered a set.
     * @return criteriaSetHash The identifier for this criteria set.
     */
    function addCriteriaSet(bytes32[] calldata _hashes) external override returns (bytes32 criteriaSetHash) {
        criteriaSetHash = hashOfSortedHashes(_hashes);
        if (!isCriteriaSetHash(criteriaSetHash)) {
            uint256 inputLength = _hashes.length;
            <span class="missing-if-branch" title="else path not taken" >E</span>require(inputLength &gt; 0, "empty set");
            CriteriaSet storage cs = criteriaSetByHash[criteriaSetHash];
            cs.exists = true;
            for (uint256 i = 0; i &lt; inputLength; i++) {
                // In the unlikely event that gas costs prove prohibitive, use a smaller list!
                // (If gas limits reduce, any large existing sets can still be used.)
                <span class="missing-if-branch" title="else path not taken" >E</span>require(registeredCriteria[_hashes[i]], "Unrecognised hash");
                <span class="missing-if-branch" title="else path not taken" >E</span>require(!cs.hashes[_hashes[i]], "Duplicated input hash");
                cs.hashes[_hashes[i]] = true;
            }
            emit CriteriaSetAdded(criteriaSetHash, _hashes);
        }
        return criteriaSetHash;
    }
&nbsp;
    /**
     * @notice Check whether the specified hash is the hash of a CriteriaSet that is known to our contract.
     * @param _criteriaSetHash The hash to look for.
     * @return valid True if the hash is that of a known CriteriaSet; false if it is not.
     */
    function isCriteriaSetHash(bytes32 _criteriaSetHash) public view override returns (bool valid) {
        return criteriaSetByHash[_criteriaSetHash].exists;
    }
&nbsp;
    /**
     * @notice Add the specified Criteria to the registry of Criteria that are known to our contract.
     * @param _criteria The Criteria to register.
     * @return hash The keccak256 of the Criteria.
     */
    function addCriteria(Criteria calldata _criteria)
        external
        override
        onlyValidCriteria(_criteria)
        returns (bytes32 hash)
    {
        hash = hashCriteria(_criteria);
        if (!registeredCriteria[hash]) {
            // Does not already exist
            registeredCriteria[hash] = true;
            emit CriteriaAdded(hash, _criteria);
        }
        return hash;
    }
&nbsp;
    /**
     * @notice Get the hash of given Criteria
     * @param _criteria The Criteria to be hashed.
     * @return The keccak256 hash of the Criteria.
     */
    function hashCriteria(Criteria calldata _criteria) public pure override returns (bytes32) {
        return
            keccak256(
                abi.encodePacked(
                    _criteria.underlyingAsset,
                    _criteria.strikeAsset,
                    _criteria.isPut,
                    _criteria.maxStrikePercent,
                    _criteria.maxDurationInDays
                )
            );
    }
&nbsp;
    /**
     * @notice Get the hash of an ordered list of hash values.
     * @param _hashes The list of bytes32 values to be hashed. This list must be sorted according to solidity's ordering, and must not contain any duplicate values.
     * @return The keccak256 hash of the set of hashes.
     */
    function hashOfSortedHashes(bytes32[] calldata _hashes) public pure override returns (bytes32) {
        if (_hashes.length &gt; 1) {
            for (uint256 i = 1; i &lt; _hashes.length; i++) {
                // In the unlikely event that gas costs prove prohibitive, use a smaller list!
                // (If gas limits reduce, existing sets can still be used.)
                require(_hashes[i] &gt; _hashes[i - 1], "Input hashes not sorted");
            }
        }
        return keccak256(abi.encodePacked(_hashes));
    }
&nbsp;
    /**
     * @notice Check whether the specified Criteria hash exists within the specified CriteriaSet.
     * @dev Clients should be responsible of passing correct parameters(_criteriaSetHash and _criteriaHash), otherwise we revert.
     * @param _criteriaSetHash The criteria list to be checked.
     * @param _criteriaHash The criteria we are looking for on that list.
     * @return isInSet true if the criteria exists in the criteriaSet; false if it does not.
     */
    function isInCriteriaSet(bytes32 _criteriaSetHash, bytes32 _criteriaHash)
        external
        view
        override
        returns (bool isInSet)
    {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(isCriteriaSetHash(_criteriaSetHash), "no such list");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(registeredCriteria[_criteriaHash], "no such criteria registered");
        return criteriaSetByHash[_criteriaSetHash].hashes[_criteriaHash];
    }
&nbsp;
    /**
     * @notice Check that a given token matches some specific Criteria.
     * @param _criteria The criteria to be checked against
     * @param _otokenCache The otoken to check
     */
    function requireOtokenMeetsCriteria(Criteria calldata _criteria, OtokenProperties calldata _otokenCache)
        external
        pure
        override
    {
        require(_criteria.underlyingAsset == _otokenCache.underlyingAsset, "wrong underlying token");
        require(_criteria.strikeAsset == _otokenCache.strikeAsset, "wrong strike token");
        require(_criteria.isPut == _otokenCache.isPut, "call options not supported");
        require(_criteria.maxStrikePercent &gt;= _otokenCache.percentStrikeValue, "invalid strike%");
        require(_criteria.maxDurationInDays &gt;= _otokenCache.wholeDaysRemaining, "invalid duration");
    }
&nbsp;
    /// @dev Neither a zero maxDuration nor a zero maxStrikePercent makes any sense
    modifier onlyValidCriteria(Criteria calldata _criteria) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_criteria.maxDurationInDays &gt; 0, "Invalid duration");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_criteria.maxStrikePercent &gt; 0, "Invalid strike%");
        _;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu May 05 2022 11:54:59 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
