<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for helpers/HedgingVaultOrchestrator.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">helpers/</a> HedgingVaultOrchestrator.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.86% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>13/14</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.33% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">95.24% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>20/21</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-yes">45×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * SPDX-License-Identifier: Apache-2.0
 */
pragma solidity 0.8.14;
&nbsp;
import { IPotionBuyAction } from "../interfaces/IPotionBuyAction.sol";
import { ISwapToUSDCAction } from "../interfaces/ISwapToUSDCAction.sol";
import { IVault } from "../interfaces/IVault.sol";
import { IRoundsInputVault } from "../interfaces/IRoundsInputVault.sol";
import { IRoundsOutputVault } from "../interfaces/IRoundsOutputVault.sol";
import { PotionBuyInfo } from "../interfaces/IPotionBuyInfo.sol";
import { Ownable } from "@openzeppelin/contracts/access/Ownable.sol";
import { IUniswapV3Oracle } from "../interfaces/IUniswapV3Oracle.sol";
import { IPotionProtocolOracle } from "../interfaces/IPotionProtocolOracle.sol";
import { ILifecycleStates } from "../interfaces/ILifecycleStates.sol";
import "../interfaces/IHedgingVaultOrchestrator.sol";
&nbsp;
/**  
    @title HedgingVaultOrchestrator
&nbsp;
    @author Roberto Cano &lt;robercano&gt;
&nbsp;
    @notice Helper contract to allow the operator to enter and exit a position of a hedging vault using only
    one transaction. The Hedging Vault is an investment vault using the PotionBuyAction strategy. The helper
    talks to both the vault and the action separately to configure the necessary swap routes and potion buy
    counterparties, and then enters the position. This also allows to minimize the amount of slippage in the
    Uniswap V3 swap and the Potion Protocol buy.
 */
contract HedgingVaultOrchestrator is Ownable, IHedgingVaultOrchestrator {
    IVault public investmentVault;
    IPotionBuyAction public potionBuyAction;
    ISwapToUSDCAction public swapToUSDCAction;
    IRoundsInputVault public roundsInputVault;
    IRoundsOutputVault public roundsOutputVault;
&nbsp;
    IVaultV0.Strategy private _potionBuyStrategy;
    IVaultV0.Strategy private _swapToUSDCStrategy;
&nbsp;
    /// CONSTRUCTOR
&nbsp;
    /**
        @notice Constructor for the HedgingVaultOrchestrator contract
&nbsp;
        @param potionBuyStrategy_ The default strategy to buy potions
        @param swapToUSDCStrategy_ The fallback strategy to swap to USDC
     */
    constructor(IVaultV0.Strategy memory potionBuyStrategy_, IVaultV0.Strategy memory swapToUSDCStrategy_) {
        _potionBuyStrategy = potionBuyStrategy_;
        _swapToUSDCStrategy = swapToUSDCStrategy_;
    }
&nbsp;
    // STATE MODIFIERS
&nbsp;
    /**
        @inheritdoc IHedgingVaultOrchestrator
    */
    function setSystemAddresses(
        address investmentVault_,
        address potionBuyAction_,
        address swapToUSDCAction_,
        address roundsInputVault_,
        address roundsOutputVault_
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        investmentVault = IVault(investmentVault_);
        potionBuyAction = IPotionBuyAction(potionBuyAction_);
        swapToUSDCAction = ISwapToUSDCAction(swapToUSDCAction_);
        roundsInputVault = IRoundsInputVault(roundsInputVault_);
        roundsOutputVault = IRoundsOutputVault(roundsOutputVault_);
    }
&nbsp;
    /**
        @inheritdoc IHedgingVaultOrchestrator
&nbsp;
        @dev Disabling unused return because the return value of `exitPosition` is only used for composability
     */
    // slither-disable-next-line unused-return
    function nextRound(
        IUniswapV3Oracle.SwapInfo calldata potionBuyExitSwapInfo,
        PotionBuyInfo calldata potionBuyEnterBuyInfo,
        IUniswapV3Oracle.SwapInfo calldata potionBuyEnterSwapInfo,
        IUniswapV3Oracle.SwapInfo calldata swapToUSDCExitSwapInfo,
        IUniswapV3Oracle.SwapInfo calldata swapToUSDCEnterSwapInfo
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        ILifecycleStates.LifecycleState vaultState = investmentVault.getLifecycleState();
&nbsp;
        if (vaultState == ILifecycleStates.LifecycleState.Locked) {
            // Exit position
            potionBuyAction.setSwapInfo(potionBuyExitSwapInfo);
            swapToUSDCAction.setSwapInfo(swapToUSDCExitSwapInfo);
&nbsp;
            // Return value is ignored on purpose, as the value is only returned for composability
            investmentVault.exitPosition();
        }
&nbsp;
        // The order of operation here should not be of importance: the ratio of
        // assets/shares remains the same after either of these operations
        roundsInputVault.nextRound();
        roundsOutputVault.nextRound();
&nbsp;
        // Enter position
        potionBuyAction.setPotionBuyInfo(potionBuyEnterBuyInfo);
        potionBuyAction.setSwapInfo(potionBuyEnterSwapInfo);
        swapToUSDCAction.setSwapInfo(swapToUSDCEnterSwapInfo);
&nbsp;
        // Main strategy
        investmentVault.enterPositionWith(_potionBuyStrategy);
    }
&nbsp;
    /// GETTERS
&nbsp;
    /**
        @inheritdoc IHedgingVaultOrchestrator
     */
<span class="fstat-no" title="function not covered" >    function canEnterNextRound() external view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return investmentVault.canPositionBeExited();</span>
    }
&nbsp;
    /**
        @inheritdoc IHedgingVaultOrchestrator
     */
    function potionBuyStrategy() external view returns (IVaultV0.Strategy memory) {
        return _potionBuyStrategy;
    }
&nbsp;
    /**
        @inheritdoc IHedgingVaultOrchestrator
     */
    function swapToUSDCStrategy() external view returns (IVaultV0.Strategy memory) {
        return _swapToUSDCStrategy;
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Dec 01 2022 09:09:45 GMT+0100 (Central European Standard Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
