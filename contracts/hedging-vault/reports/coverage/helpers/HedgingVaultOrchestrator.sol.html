<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for helpers/HedgingVaultOrchestrator.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">helpers/</a> HedgingVaultOrchestrator.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">90% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>9/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>4/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">66.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>2/3</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.86% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>13/14</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * SPDX-License-Identifier: Apache-2.0
 */
pragma solidity 0.8.14;
&nbsp;
import { IPotionBuyAction } from "../interfaces/IPotionBuyAction.sol";
import { IVault } from "../interfaces/IVault.sol";
import { IRoundsInputVault } from "../interfaces/IRoundsInputVault.sol";
import { IRoundsOutputVault } from "../interfaces/IRoundsOutputVault.sol";
import { PotionBuyInfo } from "../interfaces/IPotionBuyInfo.sol";
import { Ownable } from "@openzeppelin/contracts/access/Ownable.sol";
import { IUniswapV3Oracle } from "../interfaces/IUniswapV3Oracle.sol";
import { IPotionProtocolOracle } from "../interfaces/IPotionProtocolOracle.sol";
import { ILifecycleStates } from "../interfaces/ILifecycleStates.sol";
import { IHedgingVaultOrchestrator } from "../interfaces/IHedgingVaultOrchestrator.sol";
&nbsp;
/**  
    @title HedgingVaultOrchestrator
&nbsp;
    @author Roberto Cano &lt;robercano&gt;
&nbsp;
    @notice Helper contract to allow the operator to enter and exit a position of a hedging vault using only
    one transaction. The Hedging Vault is an investment vault using the PotionBuyAction strategy. The helper
    talks to both the vault and the action separately to configure the necessary swap routes and potion buy
    counterparties, and then enters the position. This also allows to minimize the amount of slippage in the
    Uniswap V3 swap and the Potion Protocol buy.
 */
contract HedgingVaultOrchestrator is Ownable, IHedgingVaultOrchestrator {
    IVault public investmentVault;
    IPotionBuyAction public potionBuyAction;
    IRoundsInputVault public roundsInputVault;
    IRoundsOutputVault public roundsOutputVault;
&nbsp;
    /**
        @notice Sets the addresses of the vault and the action to be used to enter and exit the position.
&nbsp;
        @param investmentVault_ The vault to be used to enter and exit the position.
        @param potionBuyAction_ The action to be used to enter and exit the position.
        @param roundsInputVault_ The vault that accepts input deposits on behalf of the investment vault.
        @param roundsOutputVault_ The vault that accepts output withdrawals on behalf of the investment vault.
    */
    function setSystemAddresses(
        address investmentVault_,
        address potionBuyAction_,
        address roundsInputVault_,
        address roundsOutputVault_
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        investmentVault = IVault(investmentVault_);
        potionBuyAction = IPotionBuyAction(potionBuyAction_);
        roundsInputVault = IRoundsInputVault(roundsInputVault_);
        roundsOutputVault = IRoundsOutputVault(roundsOutputVault_);
    }
&nbsp;
    /**
        @notice Cycles the hedging vault system and goes to the next round. If it is the very first round (i.e. the vault
        is not locked), it just notifies the rounds vaults for the next round and enters the position.
&nbsp;
        If it is not the very first round, it exits the position, notifies the rounds vaults for the next round, and then
        enters the position again.
&nbsp;
        @param prevRoundExitSwapInfo The Uniswap V3 route to swap the received pay-out from USDC back to the hedged asset
        @param nextRoundPotionBuyInfo List of counterparties to use for the Potion Protocol buy
        @param nextRoundEnterSwapInfo The Uniswap V3 route to swap some hedged asset for USDC to pay the Potion Protocol premium
        
        @dev Only the owner of the contract (i.e. the Operator) can call this function
     */
    function nextRound(
        IUniswapV3Oracle.SwapInfo calldata prevRoundExitSwapInfo,
        PotionBuyInfo calldata nextRoundPotionBuyInfo,
        IUniswapV3Oracle.SwapInfo calldata nextRoundEnterSwapInfo
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
        ILifecycleStates.LifecycleState vaultState = investmentVault.getLifecycleState();
&nbsp;
        if (vaultState == ILifecycleStates.LifecycleState.Locked) {
            // Exit position
            potionBuyAction.setSwapInfo(prevRoundExitSwapInfo);
            investmentVault.exitPosition();
        }
&nbsp;
        // The order of operation here should not be of importance: the ratio of
        // assets/shares remains the same after either of these operations
        roundsInputVault.nextRound();
        roundsOutputVault.nextRound();
&nbsp;
        // Enter position
        potionBuyAction.setPotionBuyInfo(nextRoundPotionBuyInfo);
        potionBuyAction.setSwapInfo(nextRoundEnterSwapInfo);
        investmentVault.enterPosition();
    }
&nbsp;
    /**
        @notice Convenience function to know if the next round can be entered or not
&nbsp;
        @dev This checks if the position can be exited. This cannot account for the possibility of the position
        to be entered as this information is not made available until the position is exited
     */
<span class="fstat-no" title="function not covered" >    function canEnterNextRound() external view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return investmentVault.canPositionBeExited();</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Sep 30 2022 15:29:33 GMT+0200 (Central European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
