# Potion Hedging Vault Smart Contracts

## Summary

This repository contains the smart contracts for the Hedging Vault.

In the Potion Protocol there are 2 main actors: the LP provider and the buyer of potions. Currently the LP provider enjoys a set and forget approach in which the LP adds principal to the liquidity pool and then the system uses the pool each time a buyer wants to buy a Potion. However, the buyer needs to renew the Potion once it expires. This means that the buyer must keep managing the renewal process. If she misses a renewal, the asset she holds would be un-insured and could cause losses.

Besides this, all Potions are paid in USDC, meaning that the buyer has to keep some USDC available at all times to be able to buy Potions.

The Hedging Vault contracts provide a perpetual hedging vault that automatically purchases new Potions every time the previous Potions expire. Several Users can participate in this Vault at the same time. Each investor can add Principal into the vault in the form of the Hedged Asset, and the Vault will automatically hedge the asset with the Potion Protocol and renew these potions on every cycle.

Before getting started please be sure to have read the main [README.md](../../README.md) with instructions on the needed requirements and how to install all the dependencies.

## Compile / Build

From the top of the repository run:
`yarn nx run @potion-protocol/hedging-vault:compile`

## Tests

From the top of the repository the unit tests can be run with:
`yarn nx run @potion-protocol/hedging-vault:test`

## Reports

Several reports can be generated for the contracts:

-   Gas usage report: `yarn nx run @potion-protocol/hedging-vault:report-gas`
-   Coverage report: `yarn nx run @potion-protocol:hedging-vault/report-coverage`
-   Contract size report: `yarn nx run @potion-protocol/hedging-vault:report-size`

To generate all reports at once, run:
`yarn nx run @potion-protocol/hedging-vault:report`

The reports are generated in the `reports` folder.

## Deployments

The project includes a deployment script located at `./scripts/deploy.ts`. This script imports a configuration file (`./scripts/config/deployConfig`) that includes configuration information for the different Ethereum networks(kovan, goerli, mainnet) and development environments.

This file can be used to tweak or add new configurations. A good example of configuration is the one used for the Mumbai testnet as it contains all the elements needed to succesfully deploy the contracts.

All deployment options generate a set of deployment files that are stored in the `deployments` folder. These files are used by other parts of the system to load the correct addresses for the deployed contracts.

### Mumbai Deployment

The Mumbai deployment needs several steps to be performed correctly:

-   Deploy the Potion Core pre-requisites: `yarn nx run @potion-protocol/core:prepare-testcomp-mumbai`. This will deploy the fake tokens used for the Mumbai deployment.
-   Deploy the Potion core contracts: `yarn nx run @potion-protocol/core:deploy-mumbai.testcomp` will deploy the independent Opyn protocol plus the Potion core contracts.
-   Deploy the Hedging Vault pre-requisites: `yarn nx run @potion-protocol/hedging-vault:prepare-mumbai.testcomp`. This deploys the fake Uniswap router used in the Mumbai deployment. The fake Uniswap router is needed to provide liquidity to the fake tokens used in the Mumbai deployment.
-   Deploy the Hedging Vault contracts: `yarn nx run @potion-protocol/hedging-vault:deploy-mumbai.testcomp` will deploy the Hedging Vault contracts using all the previously deployed contracts.

## Repo Structure

The repository is structured as follows:

-   `contracts`: contains the smart contracts. The structure of this folder is detailed below in another section.
-   `deployments`: contains all the deployment scripts and the deployment configuration files.
-   `reports`: contains the reports generated by the `report` command
-   `scripts`: contains the deployment scripts and the configuration files for the different networks.
-   `src`: contains the index files for the different deployment modes. Of particular interest is the `index.ts` file that contains all deployed contracts, both local and remote.
-   `tasks`: contains custom Hardhat tasks that can be used to interact with the contracts.
-   `templates`: contains the template for generating the contracts documentation
-   `test`: contains the unit tests for the contracts.

### Contracts Structure

For a deeper understanding of the different contracts refer to the [Architecture](#architecture) section below. The contracts folder is structured as follows:

-   `common`: contains common contracts used by the other contracts. This includes contracts like `EmergencyLock` or `RolesManager` that are used by several contracts in the system
-   `extensions`: contains extensions to Open Zeppelin contract like `ERC1155FullSupply` or `ERC4626Cap` that are still not available from Open Zeppelin themselves
-   `interfaces`: contains the interfaces for the contracts. These interfaces are used by the other contracts to interact with the contracts.
-   `test`: contains the test contracts used for testing purposes, like mocks or other types of contracts used in the unit tests
-   `library`: contains the contracts that are used as libraries. These contracts are not deployed as standalone contracts, but are used by other contracts. Among these are libraries like `UniswapV3Swap` used to interact with the Uniswap V3 router, or the `PotionProtocol` library used to interact with the Potion Protocol.
-   `vault`: contains the contracts for the main vault contract called the `InvestmentVault`. This contracts is one of the top-level contracts in the system.
-   `actions`: contains the contracts for the actions that can be performed by the `InvestmentVault`. These actions are the ones that are used by the `InvestmentVault` to perform the different operations. This folder in itself has an internal structure:
    -   `common`: contains common contracts used by the different actions. It includes contracts to manage the different routes used for Uniswap swapping or for Potion buying
    -   `PotionBuyAction`: is the main contract used in the Potion Buy investment strategy
    -   `SwapToUSDC`: is the main contract used in the Swap to USDC investment strategy
-   `rounds`: contains the contracts for the Rounds Vaults, which are top-level contracts in the Hedging Vault system. It includes a base contract with common functionality and the two specific contracts for the Rounds Input and Rounds Output vaults.
-   `helpers`: contains helper contracts that basically allow to perform operations in a single transaction. It includes the `HedgingVaultOrchestrator` that acts as a front-contract for the Operator, and the `RoundsVaultExchanger` that is a helper contracts for users to easily exchange assets in the system
-   `versioning`: contains the contracts for the versioning system. This contracts hold the storage layout for the different versions of the system so the upgrade process is safer and the storage layout is preserved. The contracts for version 0 are provided.

## Architecture

The Hedging Vault system is composed of 7 top-level contracts. The decision to separate the functionality in so many contracts was to offer a higher level of security and composability by re-using known concepts and contracts. Also with the hope that some parts of the system could be replaced in the future by third-party libraries like Open Zeppelin as its functionality seems to be common-place in the DeFi ecosystem.

### Investment Vault

The main contract for the Hedging Vault system is the `InvestmentVault`. This contract implements an `ERC4626` with some modifications for access control and asset capping. It allows an investor to deposit assets and receive shares of the vault. Usually this type of contract is open to users but in our case it is held at the core of the system and not used externally. Only other contracts and privileged users can interact with the `InvestmentVault`.

The main purpose of the `InvestmentVault` contract is to keep track of how many funds are deposited in the system and how many shares are issued. It also knows which investment actions are available in the system and sends the funds to the actions indicated by the Operator through the investment strategy. When the actions have finished their investment cycle the 'InvestmentVault` receives the funds back and adjusts the share price accordingly.

### Actions

An action is an individual investment strategy that can be used in a combined investment strategy. The individual investment strategy takes care of a single investment type, like buying potions or swapping to USDC. The `InvestmentVault` can combine several actions in a single investment strategy. The `InvestmentVault` will send the funds to the different actions in the investment strategy and will receive the funds back from the actions when the investment cycle is finished.

In the current iteration there are 2 actions available:

-   `PotionBuyAction`: this action is used to buy potions in the Potion Protocol. It basically hedges the received amount to protect it from the downside risk.
-   `SwapToUSDC`: this action is used to swap the received funds to USDC. It is used when the funds cannot be hedged in the Potion Protocol, as a fallback strategy.

Only one of the two actions is used in the investment strategy every round. First the `PotionBuyAction` tries to hedge the funds, and if not possible, then the `SwapToUSDC` action is used.

#### Potion Buy Action

This is the main action in the system and it is used to hedge the received funds through the Potion Protocol. It receives the set of LPs to be used to buy potions, sent by the Operator, and at the beginning of the hedging period buys the necessary amount of potions to hedge the funds. It takes care of swapping part of the funds to USDC to pay for the Potions, buys the potions, and locks the funds until the next hedging period.

When the end of the period arrives, it exercises the potions, receives any possible payout in USDC, and swaps back this USDC to the hedged asset. It then sends the funds back to the `InvestmentVault`.

#### Swap to USDC Action

This action is used as a fallback strategy when the funds cannot be hedged in the Potion Protocol. It receives the Uniswap route to be used to swap to USDC, sent by the Operator, and at the beginning of the hedging period swaps the received funds to USDC. It then locks the funds until the next hedging period. This is used to protect the assets from the downside risk, but it also prevents the assets to benefit from the upside. It is a way for the vault to handle an edge case when the funds cannot be hedged in the Potion Protocol.

When the end of the period arrives, it swaps back the USDC to the hedged asset. It then sends the funds back to the `InvestmentVault`.

### Rounds Vaults

The Rounds Vaults are 2 top-level contracts that give access to the system to external users. Its purpose is to allow users to deposit funds while the `InvestmentVault` is locked because of the funds being invested.

The Rounds Vaults are composed of 2 contracts:

-   `RoundsInputVault`: this contract is used to deposit funds in the system at any moment. In return the depositor receives a receipt in the form of a ERC-1155 token that indicates in which investment round the funds were deposited and how many assets were deposited in that round.
-   `RoundsOutputVault`: this contract is used to withdraw funds from the system. Users can deposit shares in this contract and receive back a receipt in the form of a ERC-1155 token that indicates in which investment round the shares were deposited and how many shares were deposited in that round. The user can then exchange the receipt for the funds in a later round.

#### Rounds Input Vault

The `RoundsInputVault` is used to deposit funds in the system. Because the `InvestmentVault` is typically locked when the funds are being invested, the `RoundsInputVault` is used to deposit funds in the system at any moment. The vault emits a receipt that contains the round number for the deposit and the amount of assets deposited. This receipt can then be exchanged for shares at a later round. This is done to ensure that depositors only participate in the vault once the current round is finished, and the gains and losses for the current round are known.

#### Rounds Output Vault

The `RoundsOutputVault` is used to withdraw funds from the system. The user deposits shares in the vault and receives a receipt in the form of a ERC-1155 token that indicates in which investment round the shares were deposited and how many shares were deposited in that round. The user can then exchange the receipt for the funds in a later round. This is done to set apart the correct amount of funds for the withdrawal according to the price at the end of the round in which the withdrawal request was done.

### Hedging Vault Orchestrator

The `HedgingVaultOrchestrator` is a helper contract that allows the Operator to perform operations in the system in a single transaction. It is used to provide a front-end for the Operator to perform the next round operation in a simpler way.

It allows the Operator to perform the following operations in a single transaction:

-   Set the exit Uniswap route for the Potion Buy Action, used when swapping the payout from USDC back to the hedged asset. This route is used for exiting the current round
-   Set the exit Uniswap route for the Swap to USDC Action, used when swapping the funds from USDC back to the hedged asset, in case the `PotinBuyAction` cannot hedge the funds. This route is used for exiting the current round
-   Set the enter Uniswap route for the Potion Buy Action, used when swapping the funds from the hedged asset to USDC to pay for the potions. This route is used for entering the next round
-   Set the enter Uniswap route for the Swap to USDC Action, used when swapping the funds from the hedged asset to USDC. This route is used for entering the next round
-   Set the LPs to be used for the `PotionBuyAction` to hedge the funds
-   Move to the next round

### Rounds Vault Exchanger

The `RoundsVaultExchanger` is a helper contract that allows Users to easily exchange their `RoundsInputVault` receipts for `RoundsOutputVault` receipts. It is used to provide a front-end for the Users to perform the exchange in a simpler way. It basically handles withdrawals request by directly using `RoundsInputVault` receipts without forcing the User to manually exchaging the receipt for shares.

## Wrap-up

The system is designed with composability in mind and it supports different investment strategies to be implemented. The current iteration implements a Hedging Vault in which the assets are protected from the downside by buying Potions in the Potion Protocol.

The current version is NOT AUDITED and it should be audited before using it in a production environment.
